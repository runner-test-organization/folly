# This file was @generated by getdeps.py

name: linux

on:
  push:
    branches:
    - test-codebuild

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        index: [1]
        include:
          - runs-on: ["codebuild-aws-frankfurt-${{ github.run_id }}-${{ github.run_attempt }}", "image:ubuntu-7.0", "instance-size:small"]
          # - runs-on: ["codebuild-aws-ohio-${{ github.run_id }}-${{ github.run_attempt }}", "image:ubuntu-7.0", "instance-size:small"]
          # - runs-on: ubicloud-standard-2
          # - runs-on: ubicloud-standard-4
    runs-on: ${{ matrix.runs-on }}
    name: ${{ matrix.runs-on }} \#${{ matrix.index }}
    steps:
    - name: cat /proc/cpuinfo
      run: cat /proc/cpuinfo

    - name: uname -mr
      run: uname -mr

    - name: nproc
      run: nproc

    - name: lscpu
      run: lscpu

    - name: free -h
      run: free -h

    - name: lsblk
      run: lsblk

    - name: df -Th
      run: df -Th
    
    - name: ip info
      run: curl ipinfo.io

    - name: lspci
      continue-on-error: true
      run: lspci -vv

    - name: printenv
      run: printenv

    - name: cat /etc/environment
      run: cat /etc/environment

    - name: whoami
      run: whoami

    - run: sudo apt-get update

    - name: install passmark
      run: |
        sudo apt-get install -y libncurses5
        wget "https://www.passmark.com/downloads/pt_linux_x64.zip" -O pt.zip
        unzip pt.zip
    
    - name: run passmark
      run: |
        # Run PerformanceTest with 2 proccesses, 2 iterations
        TERM=xterm ./PerformanceTest/pt_linux_x64 -p 2 -d 2 -i 2 -r 1

    - name: passmark results
      run: cat results_cpu.yml
    
    - name: hel download
      run: |
        curl -o hel1 -s -w "Download speed: %{speed_download} bytes/sec\n" https://hel1-speed.hetzner.com/1GB.bin

    - name: fsn download
      run: |
        curl -o fsn1 -s -w "Download speed: %{speed_download} bytes/sec\n" https://fsn1-speed.hetzner.com/1GB.bin

    - name: us east download
      run: |
        curl -o ash -s -w "Download speed: %{speed_download} bytes/sec\n" https://ash-speed.hetzner.com/1GB.bin

    - name: Upload cache to GHA cache
      uses: actions/cache/save@v4
      with:
        path: hel1
        key: ${{ matrix.index }}-${{ github.run_id }}-${{ github.run_attempt }}

    - run: rm -f hel1

    - name: Download cache from GHA cache
      uses: actions/cache/restore@v4
      with:
        path: hel1
        key: ${{ matrix.index }}-${{ github.run_id }}-${{ github.run_attempt }}

 
    - name: Upload cache to GHA cache
      if: ${{ startsWith(matrix.runs-on, 'ubicloud') }}
      uses: ubicloud/cache/save@v4
      with:
        path: hel1
        key: ${{ matrix.index }}-${{ github.run_id }}-${{ github.run_attempt }}
  
    - run: rm -f hel1
  
    - name: Download cache from GHA cache
      if: ${{ startsWith(matrix.runs-on, 'ubicloud') }}
      uses: ubicloud/cache/restore@v4
      with:
        path: hel1
        key: ${{ matrix.index }}-${{ github.run_id }}-${{ github.run_attempt }}
 
    - name: install fio
      run: sudo apt-get install -y fio

    - name: fio random read 4k
      run: |
        sudo fio --filename=./f --size=2GB --direct=1 --rw=randread --bs=4k --ioengine=libaio \
                --iodepth=256 --runtime=30 --numjobs=4 --time_based --group_reporting \
                --name=iops-test-job --eta-newline=1

    - name: fio random read 1M
      run: |
        sudo fio --filename=./f --size=2GB --direct=1 --rw=randread --bs=1M --ioengine=libaio \
                --iodepth=256 --runtime=30 --numjobs=4 --time_based --group_reporting \
                --name=iops-test-job --eta-newline=1

    - name: fio random write 4k
      run: |            
        sudo fio --filename=./f --size=2GB --direct=1 --rw=randwrite --bs=4k --ioengine=libaio \
                --iodepth=256 --runtime=30 --numjobs=4 --time_based --group_reporting \
                --name=iops-test-job --eta-newline=1

    - name: fio random write 1M
      run: |
        sudo fio --filename=./f --size=2GB --direct=1 --rw=randwrite --bs=1M --ioengine=libaio \
                --iodepth=256 --runtime=30 --numjobs=4 --time_based --group_reporting \
                --name=iops-test-job --eta-newline=1

    - name: fio seq read 4k
      run: |
        sudo fio --filename=./f --size=2GB --direct=1 --rw=read --bs=4k --ioengine=libaio \
                --iodepth=256 --runtime=30 --numjobs=4 --time_based --group_reporting \
                --name=iops-test-job --eta-newline=1

    - name: fio seq read 1M
      run: |
        sudo fio --filename=./f --size=2GB --direct=1 --rw=read --bs=1M --ioengine=libaio \
                --iodepth=256 --runtime=30 --numjobs=4 --time_based --group_reporting \
                --name=iops-test-job --eta-newline=1

    - name: fio seq write 4k
      run: |            
        sudo fio --filename=./f --size=2GB --direct=1 --rw=write --bs=4k --ioengine=libaio \
                --iodepth=256 --runtime=30 --numjobs=4 --time_based --group_reporting \
                --name=iops-test-job --eta-newline=1

    - name: fio seq write 1M
      run: |
        sudo fio --filename=./f --size=2GB --direct=1 --rw=write --bs=1M --ioengine=libaio \
                --iodepth=256 --runtime=30 --numjobs=4 --time_based --group_reporting \
                --name=iops-test-job --eta-newline=1